#!/usr/bin/env node

var program = require('commander')
  , jsdom = require("jsdom")
  , exec  = require('child_process').exec

program
  .version('0.0.1')
  .parse(process.argv);

console.log("loading hacker news ...")

jsdom.env("http://news.ycombinator.com", [
  'http://code.jquery.com/jquery-1.5.min.js'
],
function(errors, window) {

  var stories = []
    , options = []

  window.$("body").find("table table td.title").each(function(){

    var title = window.$(this).find("a").text()
      , href = window.$(this).find("a").attr("href")

    if(title){
      stories.push({
        title: title,
        href: href
      })

      options.push(title)
    }

  })

  var choose = function() {

    console.log("choose a story: ")

    program.choose(options, function(i){
      console.log('opening "%s"', i, options[i])
      exec('open ' + stories[i].href, function(err, stdout, stderr) {
        if(err) console.log(err)
      })

      choose.call()

    })

  }

  choose.call()

})
